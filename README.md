# CVE-2018-14667

After spending many time to understand and correctly exploit this CVE, I decided to build a repo on the RichFaces 3.X RCE bug and share the HOWTOs step by step with the community.

**0x00 : Introduction on RichFaces 3.X bug**
<p align="left">
  <img src="https://raw.githubusercontent.com/syriusbughunt/CVE-2018-14667/master/img/RichFaces.jpg" width="350" title="hover text">
</p>

On Monday, November 19, *Joao F M Figueiredo* published a well detailed article (https://seclists.org/fulldisclosure/2018/Nov/47) on a critical high-risk RichFaces vulnerability.  
**CVSS3 Base Score	9.8**

This vulnerability will allow any unauthenticated users to perform remote code execution on any web application using RichFaces 3.X (all version) which is pretty much the worst case scenario.

**0x01 : Am I affected?**&nbsp; <img src="https://raw.githubusercontent.com/syriusbughunt/CVE-2018-14667/master/img/screaming.jpg" width="20"/>

Well, if you are running RichFaces 3.X (any version of RichFaces 3) and you see the following code in your source, chances are that yes, you might be vulnerable to remote code execution on CVE-2018-14667:

* org.ajax4jsf.resource.InternetResource  
* org.ajax4jsf.resource.SerializableResource  
* javax.el.Expression  
* javax.faces.el.MethodBinding  
* javax.faces.component,StateHolderSaver  
* java.awt.Color  

**0x02 : Running a vulnerable environment to test the bug**&nbsp; <img src="https://raw.githubusercontent.com/syriusbughunt/CVE-2018-14667/master/img/bug.jpg" width="20"/>

I will basically re-explain what has been already covered in the article of seclists.org on how to deploy a vulnerable environment.  
1. Download JBoss 5.1.0GA and a demo application with RichFaces which contains the PhotoAlbum application.    
→ http://downloads.jboss.org/richfaces/releases/3.3.X/3.3.4.Final/richfaces-examples-3.3.4.Final.zip  
→ https://sourceforge.net/projects/jboss/files/JBoss/JBoss-5.1.0.GA/
2. Unzip the ZIP archive.  
3. Copy the application *richfaces-examples-3.3.4.Final/photoalbum/dist/photoalbum-ear-3.3.4.Final.ear* to the JBoss deploy directory *jboss-5.1.0.GA/server/default/deploy/*  
4. Start the JBoss application server using the following syntax (make sure before launching that your port 8080 is not already in use): cd bin ; ./run.sh -b 0.0.0.0  
5. You'll need to browse on the PhotoAlbum Index page in order to activate the web application.  

**0x03 : Generating a valid payload**&nbsp; <img src="https://raw.githubusercontent.com/syriusbughunt/CVE-2018-14667/master/img/smirk.jpg" width="20"/>

Now the fun part! This is where I've experienced difficulties so I will explain in details how to generate a valid payload and without repeating the same errors I did. I would suggest first to use Eclipse for compiling the payload.  
1. Download Eclipse on the following link:  
→ https://www.eclipse.org/downloads/  
2. Launch Eclipse and choose to create a new Web Project.  
3. Get the payload generator (credits goes to *orich1* from https://xz.aliyun.com/t/3264) available in this repo  
→ https://raw.githubusercontent.com/syriusbughunt/CVE-2018-14667/master/Main.java  
4. Extract the WAR archive in this repo (richfaces-demo-3.3.0.GA-tomcat6.war), copy all .jar files from WEB-INF/lib/ folder to WebContent/WEB-INF/lib/ in your Java Web Project in Eclipse  
→ https://github.com/syriusbughunt/CVE-2018-14667/blob/master/richfaces-demo-3.3.0.GA-tomcat6.war  
5. Add the *Main.java* file in Eclipse; right-click on your Java Web Project name in Eclipse, New, File.  
6. Make the WebContent/WEB-INF/lib folder as the Build Path source in Eclipse; right-click on the lib folder, Build Path, Use as Source Folder.  
7. Let's see if you can get lucky; click on the green Play button to run the compiler. If you get 0 errors and a valid payload in your output, congratulations, you now have a valid payload for CVE-2018-14667. Now, if you are having all kind of errors, don't panic. You might want to comment the  following lines: 29,30,31,32,33,34,35 to look like this:  
```
        // Class clazz = Class.forName("javax.el.MethodExpression");
        // Field field = clazz.getField("serialVersionUID");
        // field.setAccessible(true);
        // Field modifiersField = Field.class.getDeclaredField("modifiers");
        // modifiersField.setAccessible(true);
        // modifiersField.setInt(field, field.getModifiers() & ~Modifier.FINAL);
        // field.setLong(null, MethodExpressionSerialVersionUID);
```


